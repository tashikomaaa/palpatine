#!/usr/bin/env bash
# palpatine - main launcher
# v6 - loads config, sources lib/*.sh and runs the TUI or CLI actions.
#
# All comments in this repo are in English for open-source usage.

set -euo pipefail
IFS=$'\n\t'

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$BASE_DIR/lib"

# ----------------------------
# Load configuration files (if any)
# Precedence: /etc/palpatine.conf -> $HOME/.palpatine.conf -> $PWD/.palpatine.conf
# These files should set variables like GROUP, SSH_USER, MAX_JOBS, SSH_TIMEOUT, UI_LANG, DRY_RUN, etc.
# ----------------------------
CONFIG_PATHS=(
  "/etc/palpatine.conf"
  "$HOME/.palpatine.conf"
  "$PWD/.palpatine.conf"
)

for conf in "${CONFIG_PATHS[@]}"; do
  if [[ -f "$conf" ]]; then
    # shellcheck disable=SC1090
    source "$conf"
  fi
done

# ----------------------------
# Source library files
# All core functions live in lib/*.sh
# ----------------------------
for file in "$LIB_DIR"/*.sh; do
  # shellcheck disable=SC1090
  source "$file"
done

# Load optional plugins (if any register themselves)
load_plugins

# Opening loader (ASCII art banner)
show_loader(){
  cat <<'EOF'
                  â¢ â£²â£¼â ›â ›â£§â£–â¡„â €â €
                â¢ â¡²â ™â â €â¢°â¡†â €â ˆâ ‹â¢–â¡„
                â£¶â¡—â €â ›â¢¦â£¾â£·â£´â ›â €â¢ºâ£¶
                â ¿â¡§â €â£¤â žâ¢¿â¡¿â »â£¤â €â¢¼â ¿
                â ˜â µâ£ â¡€â €â ¸â ‡â €â¢€â£¤â ®â ƒ
                â €â €â ˜â ½â¢»â£¤â£¤â¡Ÿâ ¯â ƒâ €
__________        .__                __  .__               
\______   \_____  |  | ___________ _/  |_|__| ____   ____  
 |     ___/\__  \ |  | \____ \__  \\   __\  |/    \_/ __ \ 
 |    |     / __ \|  |_|  |_> > __ \|  | |  |   |  \  ___/ 
 |____|    (____  /____/   __(____  /__| |__|___|  /\___  >
                \/     |__|       \/             \/     \/ 
â €
         
EOF
  sleep 2
  clear
}

show_loader

prompt_add_server(){
  local input prompt
  prompt=$'\e[94m'"$(L 'prompt.add_server' 2>/dev/null || echo 'Server to add:') "
  read -rp "${prompt}${COL_RESET}" input
  if [[ -z "${input//[[:space:]]/}" ]]; then
    alert "$(L 'alert.cancel' 2>/dev/null || echo 'Operation cancelled.')"
    return
  fi
  if add_server_entry "$input"; then
    load_servers
  fi
}

prompt_remove_server(){
  local input prompt target idx

  if (( ${#SERVERS[@]} == 0 )); then
    alert "$(L 'msg.no_servers' 2>/dev/null || echo 'No servers found.')"
    return
  fi

  draw_line
  echo -e " ${COL_MENU}$(L 'menu.remove_server' 2>/dev/null || echo 'Remove a server')${COL_RESET}"
  local i=1
  for srv in "${SERVERS[@]}"; do
    printf '  [%d] %s\n' "$i" "$srv"
    ((i++))
  done
  draw_line

  prompt=$'\e[94m'"$(L 'prompt.remove_server' 2>/dev/null || echo 'Server to remove (number or host):') "
  read -rp "${prompt}${COL_RESET}" input
  input="${input//[[:space:]]/}"
  if [[ -z "$input" ]]; then
    alert "$(L 'alert.cancel' 2>/dev/null || echo 'Operation cancelled.')"
    return
  fi

  if [[ "$input" =~ ^[0-9]+$ ]]; then
    idx=$input
    if (( idx >= 1 && idx <= ${#SERVERS[@]} )); then
      target="${SERVERS[$((idx-1))]}"
    else
      alert "$(L 'alert.invalid' 2>/dev/null || echo 'Invalid choice.')"
      return
    fi
  else
    target="$input"
  fi

  if remove_server_entry "$target"; then
    load_servers
  fi
}

# ----------------------------
# CLI argument parsing
# ----------------------------
ACTION=""      # status|run|reboot|shutdown
CMDLINE=""     # command for run
FOCUS=""       # focus server (name or index)
ADD_SERVER=""
REMOVE_SERVER=""

print_help(){
  cat <<EOF
$APP_NAME $VERSION - $TAGLINE

Usage:
  $0 [--group <name>] [--user <sshuser>] [--dry-run]
     [--action <status|run|reboot|shutdown>] [--cmd "<command>"]
     [--focus "<server|index>"] [--add-server <host>] [--remove-server <host>] [--help]

Examples:
  $0 --group prod --action status
  $0 --group staging --action run --cmd "df -h"
  $0 --action reboot --dry-run
  $0 --focus "root@web-01"
  $0 --group prod --add-server "admin@web-04"
  $0 --remove-server "legacy-host"
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --group) GROUP="$2"; shift ;;
    --user) SSH_USER="$2"; shift ;;
    --action) ACTION="$2"; shift ;;
    --cmd) CMDLINE="$2"; shift ;;
    --dry-run) DRY_RUN=true ;;
    --focus) FOCUS="$2"; shift ;;
    --add-server) ADD_SERVER="$2"; shift ;;
    --remove-server) REMOVE_SERVER="$2"; shift ;;
    -h|--help) print_help; exit 0 ;;
    *) failure "Invalid option: $1"; print_help; exit 2 ;;
  esac
  shift
done

# ----------------------------
# Server list management (non-interactive shortcuts)
# ----------------------------
if [[ -n "$ADD_SERVER" && -n "$REMOVE_SERVER" ]]; then
  failure "Cannot use --add-server and --remove-server at the same time."
  exit 2
fi

if [[ -n "$ADD_SERVER" ]]; then
  if add_server_entry "$ADD_SERVER"; then
    exit 0
  else
    exit 1
  fi
fi

if [[ -n "$REMOVE_SERVER" ]]; then
  if remove_server_entry "$REMOVE_SERVER"; then
    exit 0
  else
    exit 1
  fi
fi

# ----------------------------
# Bootstrap UI and load servers
# ----------------------------
draw_header
load_servers

# ----------------------------
# If focus requested directly
# ----------------------------
if [[ -n "${FOCUS:-}" ]]; then
  case "$FOCUS" in
    ''|*[!0-9]*) focus_server "$FOCUS" ;;
    *)
      if (( FOCUS >= 1 && FOCUS <= ${#SERVERS[@]} )); then
        focus_server "${SERVERS[$((FOCUS-1))]}"
      else
        failure "Invalid server index: $FOCUS"
        exit 2
      fi
      ;;
  esac
  exit 0
fi

# ----------------------------
# Non-interactive mode if ACTION provided
# ----------------------------
if [[ -n "${ACTION:-}" ]]; then
  case "$ACTION" in
    status) action_status ;;
    run)
      [[ -z "${CMDLINE:-}" ]] && { failure "--cmd is required with --action run."; exit 1; }
      action_run_command
      ;;
    reboot) action_reboot_or_shutdown "reboot" ;;
    shutdown) action_reboot_or_shutdown "shutdown" ;;
    *) failure "Unknown action: $ACTION"; exit 1 ;;
  esac
  exit 0
fi

# ----------------------------
# Interactive TUI main loop
# ----------------------------
while :; do
  draw_header
  echo -e "${COL_MENU} 1) $(L 'menu.scan')${COL_RESET}"
  echo -e "${COL_MENU} 2) $(L 'menu.run')${COL_RESET}"
  echo -e "${COL_MENU} 3) $(L 'menu.reboot')${COL_RESET}"
  echo -e "${COL_MENU} 4) $(L 'menu.shutdown')${COL_RESET}"
  echo -e "${COL_MENU} 5) $(L 'menu.focus')${COL_RESET}"

  option_plugin=0
  option_add=0
  option_remove=0
  next_option=6

  if plugins_available; then
    option_plugin=$next_option
    echo -e "${COL_MENU} ${option_plugin}) $(L 'menu.plugins')${COL_RESET}"
    ((next_option++))
  fi

  option_add=$next_option
  echo -e "${COL_MENU} ${option_add}) $(L 'menu.add_server')${COL_RESET}"
  ((next_option++))

  option_remove=$next_option
  echo -e "${COL_MENU} ${option_remove}) $(L 'menu.remove_server')${COL_RESET}"
  draw_line
  draw_menu_option "9" "ðŸšª" "$(L 'menu.quit')" "(q)"
  draw_line

  choice_prompt=$'\e[94m'"$(L 'prompt.choice') "
  read -rp "${choice_prompt}${COL_RESET}" choice
  choice="${choice,,}"
  case "$choice" in
    1|"s") action_status; pause ;;
    2) action_run_command; pause ;;
    3|"r") action_reboot_or_shutdown "reboot"; pause ;;
    4) action_reboot_or_shutdown "shutdown"; pause ;;
    5) select_server ;;
    "$option_plugin"|"p")
      if (( option_plugin > 0 )) && plugins_available; then
        show_plugin_menu
      else
        alert "$(L 'plugins.none')"
      fi
      ;;
    "$option_add"|"a") prompt_add_server; pause ;;
    "$option_remove"|"d") prompt_remove_server; pause ;;
    9|"q") victory "$(L 'victory.farewell')"; exit 0 ;;
    *) alert "$(L 'alert.invalid')" ;;
  esac
done
